apiVersion: v1
kind: Pod
metadata:
  labels:
    app: {{ awx_pod_label }}
  name: {{ awx_pod_name }}
spec:
  #
  # define exported volumes for permanent data
  #
  volumes:
  - name: awx-data-volume
    hostPath:
      path: {{ awx_data_volume_host_path }}
      type: Directory
  - name: db-volume
    hostPath:
      path: {{ awx_db_volume_host_path }}
      type: Directory
  - name: awx-secret
    hostPath:
      path: {{ awx_secret_volume_host_path }}/SECRET_FILE
      type: File
  - name: nginx-config
    hostPath:
      path: {{ awx_nginx_volume_host_path }}/nginx.conf
      type: File
  containers:
  #
  # postgres container
  #
  - command:
    - run-postgresql
    env:
    - name: POSTGRESQL_USER
      value: {{ awx_postgres_user }}
    - name: POSTGRESQL_DATABASE
      value: awx
    - name: PGDATA
      value: /var/lib/pgsql/data
    - name: POSTGRESQL_PASSWORD
      value: {{ awx_postgres_password }}
{% if awx_postgres_update %}
    - name: POSTGRESQL_UPGRADE
      value: copy
{% endif %}
    image: {{ awx_postgres_image }}
    name: {{ awx_pod_name }}_postgres
    volumeMounts:
    - mountPath: /var/lib/pgsql/data:z
      name: db-volume
  #
  # memcached container
  #
  - command:
    - docker-entrypoint.sh
    - memcached
    env:
    image: {{ awx_memcached_image }}
    name: {{ awx_pod_name }}_memcached
  #
  # awx-web container
  #
  - command:
    - /tini
    - --
    - /bin/sh
    - -c
    - /usr/bin/launch_awx.sh
    env:
    - name: AWX_ADMIN_USER
      value: {{ awx_admin_user }}
    - name: AWX_ADMIN_PASSWORD
      value: {{ awx_admin_password }}
    - name: HOSTNAME
      value: awxweb
    - name: DATABASE_NAME
      value: awx
    - name: DATABASE_USER
      value: {{ awx_postgres_user }}
    - name: DATABASE_PASSWORD
      value: {{ awx_postgres_password }}
    - name: DATABASE_PORT
      value: "5432"
    - name: DATABASE_HOST
      value: 127.0.0.1
    - name: RABBITMQ_HOST
      value: 127.0.0.1
    - name: RABBITMQ_VHOST
      value: awx
    - name: RABBITMQ_USER
      value: {{ awx_rabbitmq_user }}
    - name: RABBITMQ_PASSWORD
      value: {{ awx_rabbitmq_password }}
    - name: SECRET_KEY
      value: {{ awx_rabbitmq_secret_key }}
    - name: RABBITMQ_PORT
      value: "5672"
    - name: MEMCACHED_HOST
      value: 127.0.0.1
    - name: MEMCACHED_PORT
      value: "11211"
    image: {{ awx_awxweb_image }}
    name: {{ awx_pod_name }}_awxweb
    workingDir: /var/lib/awx
    volumeMounts:
    - mountPath: /var/lib/awx/projects:z
      name: awx-data-volume
    - mountPath: /etc/tower/SECRET_KEY:z
      name: awx-secret
      readOnly: true
    - mountPath: /etc/nginx/nginx.conf:z
      name: nginx-config
      readOnly: true
    ports:
      - containerPort: 8052
        hostPort: {{ awx_host_port }}
        protocol: TCP
  #
  # awx-task container
  #
  - command:
    - /tini
    - --
    - /bin/sh
    - -c
    - /usr/bin/launch_awx_task.sh
    env:
    - name: AWX_ADMIN_USER
      value: {{ awx_admin_user }}
    - name: AWX_ADMIN_PASSWORD
      value: {{ awx_admin_password }}
    - name: HOSTNAME
      value: awx
    - name: DATABASE_NAME
      value: awx
    - name: DATABASE_USER
      value: {{ awx_postgres_user }}
    - name: DATABASE_PASSWORD
      value: {{ awx_postgres_password }}
    - name: DATABASE_PORT
      value: "5432"
    - name: DATABASE_HOST
      value: 127.0.0.1
    - name: RABBITMQ_HOST
      value: 127.0.0.1
    - name: RABBITMQ_VHOST
      value: awx
    - name: RABBITMQ_USER
      value: {{ awx_rabbitmq_user }}
    - name: RABBITMQ_PASSWORD
      value: {{ awx_rabbitmq_password }}
    - name: SECRET_KEY
      value: {{ awx_rabbitmq_secret_key }}
    - name: RABBITMQ_PORT
      value: "5672"
    - name: MEMCACHED_HOST
      value: 127.0.0.1
    - name: MEMCACHED_PORT
      value: "11211"
    image: {{ awx_awxtask_image }}
    name: {{ awx_pod_name }}_awxtask
    workingDir: /var/lib/awx
    volumeMounts:
    - mountPath: /var/lib/awx/projects:z
      name: awx-data-volume
    - mountPath: /etc/tower/SECRET_KEY:z
      name: awx-secret
      readOnly: true
  #
  # rabbitmq container
  #
  - command:
    - docker-entrypoint.sh
    - /bin/sh
    - -c
    - /launch.sh
    env:
    - name: PATH
      value: /opt/rabbitmq/sbin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
    - name: RABBITMQ_DEFAULT_VHOST
      value: awx
    - name: RABBITMQ_ERLANG_COOKIE
      value: {{ awx_rabbitmq_erlang_cookie }}
    - name: RABBITMQ_DEFAULT_USER
      value: {{ awx_rabbitmq_user }}
    - name: RABBITMQ_DEFAULT_PASS
      value: {{ awx_rabbitmq_password }}
    image: {{ awx_rabbitmq_image }}
    name: {{ awx_pod_name }}_rabbitmq
